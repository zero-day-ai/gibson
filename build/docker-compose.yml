# Gibson Development Stack
# Full environment for development and testing with enterprise features
#
# Usage:
#   docker compose -f build/docker-compose.yml up -d
#   docker compose -f build/docker-compose.yml logs -f gibson
#   docker compose -f build/docker-compose.yml exec gibson bash
#
# Services:
#   - gibson:     Main Gibson container (enterprise)
#   - neo4j:      Knowledge graph database
#   - qdrant:     Vector database for long-term memory
#   - langfuse:   LLM observability and prompt management
#   - postgres:   Database for Langfuse
#   - jaeger:     Distributed tracing
#   - prometheus: Metrics collection
#   - grafana:    Dashboards and visualization
#   - ollama:     Local LLM serving (optional)

services:
  # =============================================================================
  # GIBSON - Main Application
  # =============================================================================
  gibson:
    image: ghcr.io/zero-day-ai/gibson-enterprise:latest
    container_name: gibson
    hostname: gibson
    stdin_open: true
    tty: true
    environment:
      # LLM Configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Neo4j GraphRAG
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=gibson-dev-2024
      # Vector Store
      - QDRANT_URL=http://qdrant:6333
      # Langfuse LLM Observability
      - LANGFUSE_HOST=http://langfuse:3000
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY:-}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY:-}
      # OpenTelemetry Tracing
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - OTEL_SERVICE_NAME=gibson
      # Metrics
      - GIBSON_METRICS_PORT=9090
      # Ollama (local LLM)
      - OLLAMA_HOST=http://ollama:11434
    volumes:
      - gibson-data:/root/.gibson
      - gibson-logs:/var/log/gibson
      # Mount host tools directory for development
      - ${HOST_TOOLS_PATH:-./tools}:/opt/gibson/tools:ro
    ports:
      # gRPC port range for tools/agents/plugins
      - "50000-50100:50000-50100"
      # Metrics endpoint
      - "9091:9090"
    depends_on:
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      langfuse:
        condition: service_started
      jaeger:
        condition: service_started
    networks:
      - gibson-net
    healthcheck:
      test: ["CMD", "gibson", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # KNOWLEDGE GRAPH - Neo4j
  # =============================================================================
  neo4j:
    image: neo4j:5-community
    container_name: gibson-neo4j
    hostname: neo4j
    environment:
      - NEO4J_AUTH=neo4j/gibson-dev-2024
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=512m
    ports:
      - "7474:7474"   # HTTP Browser
      - "7687:7687"   # Bolt protocol
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins
    networks:
      - gibson-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =============================================================================
  # VECTOR DATABASE - Qdrant
  # =============================================================================
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: gibson-qdrant
    hostname: qdrant
    ports:
      - "6333:6333"   # REST API
      - "6334:6334"   # gRPC
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - gibson-net
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:6333/readyz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # LLM OBSERVABILITY - Langfuse
  # =============================================================================
  langfuse:
    image: langfuse/langfuse:2
    container_name: gibson-langfuse
    hostname: langfuse
    environment:
      - DATABASE_URL=postgresql://langfuse:langfuse-dev@postgres:5432/langfuse
      - NEXTAUTH_SECRET=gibson-langfuse-secret-change-in-prod
      - NEXTAUTH_URL=http://localhost:3000
      - SALT=gibson-salt-change-in-prod
      - TELEMETRY_ENABLED=false
      # Default admin credentials (change in production!)
      - LANGFUSE_INIT_ORG_ID=gibson-org
      - LANGFUSE_INIT_ORG_NAME=Gibson
      - LANGFUSE_INIT_PROJECT_ID=gibson-project
      - LANGFUSE_INIT_PROJECT_NAME=Gibson Dev
      - LANGFUSE_INIT_PROJECT_PUBLIC_KEY=pk-gibson-dev
      - LANGFUSE_INIT_PROJECT_SECRET_KEY=sk-gibson-dev
      - LANGFUSE_INIT_USER_EMAIL=admin@gibson.local
      - LANGFUSE_INIT_USER_PASSWORD=gibson-admin
      - LANGFUSE_INIT_USER_NAME=Gibson Admin
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - gibson-net

  # =============================================================================
  # LANGFUSE DATABASE - PostgreSQL
  # =============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: gibson-postgres
    hostname: postgres
    environment:
      - POSTGRES_USER=langfuse
      - POSTGRES_PASSWORD=langfuse-dev
      - POSTGRES_DB=langfuse
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - gibson-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse -d langfuse"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =============================================================================
  # DISTRIBUTED TRACING - Jaeger
  # =============================================================================
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: gibson-jaeger
    hostname: jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=badger
      - BADGER_EPHEMERAL=false
      - BADGER_DIRECTORY_VALUE=/badger/data
      - BADGER_DIRECTORY_KEY=/badger/key
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "16686:16686" # Jaeger UI
      - "14268:14268" # Collector HTTP
    volumes:
      - jaeger-data:/badger
    networks:
      - gibson-net

  # =============================================================================
  # METRICS - Prometheus
  # =============================================================================
  prometheus:
    image: prom/prometheus:v2.49.0
    container_name: gibson-prometheus
    hostname: prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - gibson-net

  # =============================================================================
  # DASHBOARDS - Grafana
  # =============================================================================
  grafana:
    image: grafana/grafana:10.3.1
    container_name: gibson-grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=gibson-admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
    ports:
      - "3001:3000"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
      - jaeger
    networks:
      - gibson-net

  # =============================================================================
  # LOCAL LLM - Ollama (Optional)
  # =============================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: gibson-ollama
    hostname: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    networks:
      - gibson-net
    # Uncomment for GPU support (NVIDIA)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    profiles:
      - ollama  # Only start with: docker compose --profile ollama up

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  gibson-data:
    name: gibson-data
  gibson-logs:
    name: gibson-logs
  neo4j-data:
    name: gibson-neo4j-data
  neo4j-logs:
    name: gibson-neo4j-logs
  neo4j-plugins:
    name: gibson-neo4j-plugins
  qdrant-data:
    name: gibson-qdrant-data
  postgres-data:
    name: gibson-postgres-data
  jaeger-data:
    name: gibson-jaeger-data
  prometheus-data:
    name: gibson-prometheus-data
  grafana-data:
    name: gibson-grafana-data
  ollama-data:
    name: gibson-ollama-data

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  gibson-net:
    name: gibson-net
    driver: bridge
