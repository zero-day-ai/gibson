package harness

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
	"github.com/zero-day-ai/gibson/internal/llm"
	"github.com/zero-day-ai/gibson/internal/types"
)

// ────────────────────────────────────────────────────────────────────────────
// NewHarnessFactory Tests
// ────────────────────────────────────────────────────────────────────────────

func TestNewHarnessFactory_Success(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)
	assert.NotNil(t, factory)

	// Verify defaults were applied
	storedConfig := factory.Config()
	assert.NotNil(t, storedConfig.LLMRegistry)
	assert.NotNil(t, storedConfig.ToolRegistry)
	assert.NotNil(t, storedConfig.PluginRegistry)
	assert.NotNil(t, storedConfig.AgentRegistry)
	assert.NotNil(t, storedConfig.Logger)
	assert.NotNil(t, storedConfig.FindingStore)
	assert.NotNil(t, storedConfig.Metrics)
	assert.NotNil(t, storedConfig.Tracer)
}

func TestNewHarnessFactory_InvalidConfig_NoSlotManager(t *testing.T) {
	config := HarnessConfig{
		// Missing SlotManager
	}

	factory, err := NewHarnessFactory(config)
	require.Error(t, err)
	assert.Nil(t, factory)

	// Verify error code
	gibsonErr, ok := err.(types.Error)
	require.True(t, ok, "expected types.Error")
	assert.Equal(t, ErrHarnessInvalidConfig, gibsonErr.Code())
}

func TestNewHarnessFactory_AppliesDefaults(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
		// All other fields nil
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	storedConfig := factory.Config()

	// Verify all defaults were applied
	assert.NotNil(t, storedConfig.LLMRegistry, "LLMRegistry should be defaulted")
	assert.NotNil(t, storedConfig.ToolRegistry, "ToolRegistry should be defaulted")
	assert.NotNil(t, storedConfig.PluginRegistry, "PluginRegistry should be defaulted")
	assert.NotNil(t, storedConfig.AgentRegistry, "AgentRegistry should be defaulted")
	assert.NotNil(t, storedConfig.Logger, "Logger should be defaulted")
	assert.NotNil(t, storedConfig.FindingStore, "FindingStore should be defaulted")
	assert.NotNil(t, storedConfig.Metrics, "Metrics should be defaulted")
	assert.NotNil(t, storedConfig.Tracer, "Tracer should be defaulted")
	assert.NotNil(t, storedConfig.SlotManager, "SlotManager should remain set")
	assert.Nil(t, storedConfig.MemoryManager, "MemoryManager should not be defaulted")
}

func TestNewHarnessFactory_PreservesProvidedConfig(t *testing.T) {
	llmReg := llm.NewLLMRegistry()
	slotMgr := llm.NewSlotManager(llmReg)
	findingStore := NewInMemoryFindingStore()
	metrics := NewNoOpMetricsRecorder()

	config := HarnessConfig{
		SlotManager:  slotMgr,
		LLMRegistry:  llmReg,
		FindingStore: findingStore,
		Metrics:      metrics,
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	storedConfig := factory.Config()

	// Verify provided values were preserved
	assert.Equal(t, slotMgr, storedConfig.SlotManager)
	assert.Equal(t, llmReg, storedConfig.LLMRegistry)
	assert.Equal(t, findingStore, storedConfig.FindingStore)
	assert.Equal(t, metrics, storedConfig.Metrics)
}

// ────────────────────────────────────────────────────────────────────────────
// Factory Create Tests
// ────────────────────────────────────────────────────────────────────────────

func TestFactory_Create_PendingImplementation(t *testing.T) {
	// Note: This test documents the current state where DefaultAgentHarness
	// hasn't been implemented yet (Package 5).
	// Once implemented, this test should be replaced with success tests.

	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	missionID := types.NewID()
	missionCtx := NewMissionContext(missionID, "test-mission", "test-agent")
	targetInfo := NewTargetInfo(types.NewID(), "test-target", "https://example.com", "web")

	harness, err := factory.Create("test-agent", missionCtx, targetInfo)

	// Currently returns error indicating pending implementation
	require.Error(t, err)
	assert.Nil(t, harness)
	assert.Contains(t, err.Error(), "pending")
}

func TestFactory_Create_EmptyAgentName(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	missionID := types.NewID()
	missionCtx := NewMissionContext(missionID, "test-mission", "test-agent")
	targetInfo := NewTargetInfo(types.NewID(), "test-target", "https://example.com", "web")

	harness, err := factory.Create("", missionCtx, targetInfo)

	require.Error(t, err)
	assert.Nil(t, harness)

	gibsonErr, ok := err.(types.Error)
	require.True(t, ok, "expected types.Error")
	assert.Equal(t, ErrHarnessInvalidConfig, gibsonErr.Code())
	assert.Contains(t, err.Error(), "agent name")
}

// ────────────────────────────────────────────────────────────────────────────
// Factory CreateChild Tests
// ────────────────────────────────────────────────────────────────────────────

func TestFactory_CreateChild_NilParent(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	harness, err := factory.CreateChild(nil, "child-agent")

	require.Error(t, err)
	assert.Nil(t, harness)

	gibsonErr, ok := err.(types.Error)
	require.True(t, ok, "expected types.Error")
	assert.Equal(t, ErrHarnessInvalidConfig, gibsonErr.Code())
	assert.Contains(t, err.Error(), "parent harness")
}

func TestFactory_CreateChild_EmptyAgentName(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	// Create a mock parent harness
	mockParent := &MockAgentHarness{
		MissionFn: func() MissionContext {
			return NewMissionContext(types.NewID(), "test", "parent")
		},
		TargetFn: func() TargetInfo {
			return NewTargetInfo(types.NewID(), "test", "https://example.com", "web")
		},
	}

	harness, err := factory.CreateChild(mockParent, "")

	require.Error(t, err)
	assert.Nil(t, harness)

	gibsonErr, ok := err.(types.Error)
	require.True(t, ok, "expected types.Error")
	assert.Equal(t, ErrHarnessInvalidConfig, gibsonErr.Code())
	assert.Contains(t, err.Error(), "agent name")
}

// Note: Full CreateChild tests require DefaultAgentHarness implementation.
// The test below documents expected behavior once implemented.

func TestFactory_CreateChild_ExpectedBehavior(t *testing.T) {
	t.Skip("Waiting for DefaultAgentHarness implementation in Package 5")

	// Expected behavior once implemented:
	// 1. Should get parent's mission context and update CurrentAgent
	// 2. Should get parent's target info (shared)
	// 3. Should create child harness with Create()
	// 4. Child should share memory store with parent
	// 5. Child should share finding store with parent
	// 6. Child should have its own token tracker
	// 7. Child should have logger with updated agent attribute
}

// ────────────────────────────────────────────────────────────────────────────
// Factory Config Tests
// ────────────────────────────────────────────────────────────────────────────

func TestFactory_Config(t *testing.T) {
	llmReg := llm.NewLLMRegistry()
	slotMgr := llm.NewSlotManager(llmReg)

	config := HarnessConfig{
		SlotManager: slotMgr,
		LLMRegistry: llmReg,
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	retrievedConfig := factory.Config()

	assert.Equal(t, slotMgr, retrievedConfig.SlotManager)
	assert.Equal(t, llmReg, retrievedConfig.LLMRegistry)
}

// ────────────────────────────────────────────────────────────────────────────
// Mock AgentHarness for Testing
// ────────────────────────────────────────────────────────────────────────────

type MockAgentHarness struct {
	// LLM methods
	CompleteFn         func() error
	CompleteWithToolsFn func() error
	StreamFn           func() error

	// Tool methods
	CallToolFn func() error
	ListToolsFn func() []ToolDescriptor

	// Plugin methods
	QueryPluginFn func() error
	ListPluginsFn func() []PluginDescriptor

	// Agent methods
	DelegateToAgentFn func() error
	ListAgentsFn      func() []AgentDescriptor

	// Finding methods
	SubmitFindingFn func() error
	GetFindingsFn   func() error

	// Accessor methods
	MemoryFn      func() interface{}
	MissionFn     func() MissionContext
	TargetFn      func() TargetInfo
	TracerFn      func() interface{}
	LoggerFn      func() interface{}
	MetricsFn     func() MetricsRecorder
	TokenUsageFn  func() interface{}
}

func (m *MockAgentHarness) Mission() MissionContext {
	if m.MissionFn != nil {
		return m.MissionFn()
	}
	return NewMissionContext(types.NewID(), "test", "test-agent")
}

func (m *MockAgentHarness) Target() TargetInfo {
	if m.TargetFn != nil {
		return m.TargetFn()
	}
	return NewTargetInfo(types.NewID(), "test", "https://example.com", "web")
}

// Note: Other methods omitted for brevity - they would follow the same pattern
// and would be needed for full harness implementation tests

// ────────────────────────────────────────────────────────────────────────────
// Edge Cases and Integration Tests
// ────────────────────────────────────────────────────────────────────────────

func TestFactory_MultipleCreations(t *testing.T) {
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	missionCtx := NewMissionContext(types.NewID(), "test-mission", "agent1")
	targetInfo := NewTargetInfo(types.NewID(), "test-target", "https://example.com", "web")

	// Try creating multiple harnesses (will fail until implementation)
	_, err1 := factory.Create("agent1", missionCtx, targetInfo)
	_, err2 := factory.Create("agent2", missionCtx, targetInfo)
	_, err3 := factory.Create("agent3", missionCtx, targetInfo)

	// All should fail with same error (pending implementation)
	assert.Error(t, err1)
	assert.Error(t, err2)
	assert.Error(t, err3)
}

func TestFactory_ConfigImmutability(t *testing.T) {
	llmReg := llm.NewLLMRegistry()
	slotMgr := llm.NewSlotManager(llmReg)

	config := HarnessConfig{
		SlotManager: slotMgr,
		LLMRegistry: llmReg,
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)

	// Get config and verify it's a copy (value semantics)
	config1 := factory.Config()
	config2 := factory.Config()

	// Both should have same SlotManager
	assert.Equal(t, config1.SlotManager, config2.SlotManager)
	assert.Equal(t, config1.LLMRegistry, config2.LLMRegistry)
}

func TestFactory_ValidationBeforeDefaults(t *testing.T) {
	// Validation should happen after defaults are applied
	config := HarnessConfig{
		// No SlotManager - should fail validation
	}

	factory, err := NewHarnessFactory(config)
	require.Error(t, err)
	assert.Nil(t, factory)
	assert.Contains(t, err.Error(), "validation")
}

func TestFactory_CompleteConfiguration(t *testing.T) {
	// Test with fully specified configuration
	config := HarnessConfig{
		SlotManager:    llm.NewSlotManager(llm.NewLLMRegistry()),
		LLMRegistry:    llm.NewLLMRegistry(),
		FindingStore:   NewInMemoryFindingStore(),
		Metrics:        NewNoOpMetricsRecorder(),
		MemoryManager:  &MockMemoryStore{},
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)
	assert.NotNil(t, factory)

	storedConfig := factory.Config()

	// Verify all provided values are preserved
	assert.NotNil(t, storedConfig.SlotManager)
	assert.NotNil(t, storedConfig.LLMRegistry)
	assert.NotNil(t, storedConfig.FindingStore)
	assert.NotNil(t, storedConfig.Metrics)
	assert.NotNil(t, storedConfig.MemoryManager)

	// Defaults should still be applied for missing fields
	assert.NotNil(t, storedConfig.Logger)
	assert.NotNil(t, storedConfig.Tracer)
}

// ────────────────────────────────────────────────────────────────────────────
// Documentation Tests
// ────────────────────────────────────────────────────────────────────────────

func TestFactory_InterfaceCompliance(t *testing.T) {
	// Verify DefaultHarnessFactory implements HarnessFactoryInterface
	var _ HarnessFactoryInterface = (*DefaultHarnessFactory)(nil)
}

func TestFactory_TokenTrackerCreation(t *testing.T) {
	// Document that factory creates token trackers for each harness
	// This is verified by examining the Create method code
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)
	assert.NotNil(t, factory)

	// The Create method creates a new TokenTracker for each harness
	// (verified by code inspection in factory.go line 114)
}

func TestFactory_LoggerContextPropagation(t *testing.T) {
	// Document that factory creates loggers with agent context
	// This is verified by examining the Create method code
	config := HarnessConfig{
		SlotManager: llm.NewSlotManager(llm.NewLLMRegistry()),
	}

	factory, err := NewHarnessFactory(config)
	require.NoError(t, err)
	assert.NotNil(t, factory)

	// The Create method creates a logger with agent, mission_id, and mission_name attributes
	// (verified by code inspection in factory.go lines 117-120)
}
