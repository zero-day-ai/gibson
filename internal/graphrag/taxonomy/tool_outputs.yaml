# Tool Output Schemas for Taxonomy-Driven GraphRAG
#
# This file defines how tool outputs are parsed and converted to graph nodes.
# Each tool output schema specifies:
# - What node types to extract from the tool's JSON output
# - JSONPath expressions to locate data in the tool output
# - ID templates for creating node identifiers
# - Property mappings from JSON to node properties
# - Relationship definitions to connect nodes
#
# Special variables:
# - _context.agent_run_id: Injected by engine, current agent run ID
# - _parent: Reference to parent object in nested extractions
# - _root: Reference to root JSON object
#
# Node types must match taxonomy definitions in nodes/*.yaml

tool_outputs:
  # ============================================================================
  # NMAP - Network Mapper
  # ============================================================================
  # Extracts hosts and ports from nmap scan results
  - tool: nmap
    description: "Network discovery and port scanning tool"
    output_format: json
    extracts:
      # Extract host nodes
      - node_type: host
        json_path: "$.hosts[*]"
        id_template: "host:{.ip}"
        properties:
          - json_path: ".ip"
            target: ip
          - json_path: ".hostname"
            target: hostname
          - json_path: ".os_match"
            target: os
          - json_path: ".state"
            target: state
          - json_path: ".version"
            target: version
            default: "ipv4"
          - json_path: ".asn"
            target: asn
          - json_path: ".geo_location"
            target: geo_location
        relationships:
          # Link agent run to discovered host
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "host:{.ip}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "nmap"

      # Extract port nodes
      - node_type: port
        json_path: "$.hosts[*].ports[*]"
        id_template: "port:{_parent.ip}:{.port}:{.protocol}"
        properties:
          - json_path: ".port"
            target: number
          - json_path: ".protocol"
            target: protocol
          - json_path: ".state"
            target: state
          - json_path: "_parent.ip"
            target: host_id
            template: "host:{_parent.ip}"
        relationships:
          # Link host to port
          - type: HAS_PORT
            from_template: "host:{_parent.ip}"
            to_template: "port:{_parent.ip}:{.port}:{.protocol}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

      # Extract service nodes
      - node_type: service
        json_path: "$.hosts[*].ports[*].service"
        condition: ".name != null"
        id_template: "service:port:{_parent._parent.ip}:{_parent.port}:{_parent.protocol}:{.name}"
        properties:
          - json_path: ".name"
            target: name
          - json_path: ".version"
            target: version
          - json_path: ".banner"
            target: banner
          - json_path: ".product"
            target: product
          - json_path: ".cpe"
            target: cpe
          - json_path: "_parent._parent.ip"
            target: port_id
            template: "port:{_parent._parent.ip}:{_parent.port}:{_parent.protocol}"
        relationships:
          # Link port to service
          - type: RUNS_SERVICE
            from_template: "port:{_parent._parent.ip}:{_parent.port}:{_parent.protocol}"
            to_template: "service:port:{_parent._parent.ip}:{_parent.port}:{_parent.protocol}:{.name}"
            properties:
              - name: detected_at
                value: "{_context.timestamp}"

  # ============================================================================
  # SUBFINDER - Subdomain Discovery Tool
  # ============================================================================
  # Extracts subdomains from subfinder results
  - tool: subfinder
    description: "Fast passive subdomain enumeration tool"
    output_format: json
    extracts:
      # Extract subdomain nodes
      - node_type: subdomain
        json_path: "$.subdomains[*]"
        id_template: "subdomain:{.name}"
        properties:
          - json_path: ".name"
            target: name
          - json_path: ".parent_domain"
            target: parent_domain
          - json_path: ".source"
            target: discovery_method
          - json_path: ".is_wildcard"
            target: is_wildcard
            default: false
        relationships:
          # Link subdomain to parent domain
          - type: HAS_SUBDOMAIN
            from_template: "domain:{.parent_domain}"
            to_template: "subdomain:{.name}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "subfinder"
          # Link agent run to discovered subdomain
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "subdomain:{.name}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

      # Extract domain nodes if not already present
      - node_type: domain
        json_path: "$.target_domain"
        id_template: "domain:{.name}"
        properties:
          - json_path: ".name"
            target: name
        relationships:
          # Link agent run to target domain
          - type: TARGETED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "domain:{.name}"

  # ============================================================================
  # HTTPX - HTTP Toolkit
  # ============================================================================
  # Extracts endpoints and technologies from httpx probing
  - tool: httpx
    description: "Fast HTTP toolkit for probing web services"
    output_format: json
    extracts:
      # Extract endpoint nodes
      - node_type: endpoint
        json_path: "$.results[*]"
        id_template: "endpoint:{sha256(.method + ':' + .url)[:16]}"
        properties:
          - json_path: ".url"
            target: url
          - json_path: ".method"
            target: method
            default: "GET"
          - json_path: ".status_code"
            target: status_code
          - json_path: ".content_type"
            target: content_type
          - json_path: ".content_length"
            target: content_length
          - json_path: ".title"
            target: page_title
          - json_path: ".server"
            target: server
          - json_path: ".response_time_ms"
            target: response_time_ms
        relationships:
          # Link host to endpoint
          - type: EXPOSES_ENDPOINT
            from_template: "host:{.host}"
            to_template: "endpoint:{sha256(.method + ':' + .url)[:16]}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "httpx"
          # Link agent run to discovered endpoint
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "endpoint:{sha256(.method + ':' + .url)[:16]}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

      # Extract technology nodes
      - node_type: technology
        json_path: "$.results[*].technologies[*]"
        id_template: "technology:{.name}:{.version}"
        properties:
          - json_path: ".name"
            target: name
          - json_path: ".version"
            target: version
          - json_path: ".category"
            target: category
          - json_path: ".cpe"
            target: cpe
          - json_path: ".confidence"
            target: detection_confidence
            default: 0.8
        relationships:
          # Link endpoint to technology
          - type: USES_TECHNOLOGY
            from_template: "endpoint:{sha256(_parent.method + ':' + _parent.url)[:16]}"
            to_template: "technology:{.name}:{.version}"
            properties:
              - name: detected_at
                value: "{_context.timestamp}"
              - name: confidence
                value: "{.confidence}"

  # ============================================================================
  # NUCLEI - Vulnerability Scanner
  # ============================================================================
  # Extracts vulnerabilities from nuclei scan results
  - tool: nuclei
    description: "Fast vulnerability scanner based on templates"
    output_format: json
    extracts:
      # Extract finding nodes for vulnerabilities
      - node_type: finding
        json_path: "$.results[*]"
        id_template: "finding:{.template_id}:{sha256(.matched_at)[:16]}"
        properties:
          - json_path: ".template_id"
            target: title
            template: "{.template_id}: {.name}"
          - json_path: ".severity"
            target: severity
            transform: lowercase
          - json_path: ".confidence"
            target: confidence
            default: 0.9
          - json_path: ".type"
            target: category
          - json_path: ".cve_id"
            target: cve_id
          - json_path: ".cvss_score"
            target: cvss_score
          - json_path: ".cvss_vector"
            target: cvss_vector
          - json_path: ".cwe_id"
            target: cwe_id
          - json_path: ".description"
            target: description
          - json_path: ".remediation"
            target: remediation
          - json_path: ".reference"
            target: references
            transform: to_array
          - json_path: ".matched_at"
            target: affected_component
        relationships:
          # Link finding to affected endpoint
          - type: AFFECTS
            from_template: "finding:{.template_id}:{sha256(.matched_at)[:16]}"
            to_template: "endpoint:{sha256('GET:' + .matched_at)[:16]}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "nuclei"
          # Link agent run to finding
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "finding:{.template_id}:{sha256(.matched_at)[:16]}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

      # Extract evidence nodes
      - node_type: evidence
        json_path: "$.results[*]"
        condition: ".extracted_results != null || .curl_command != null"
        id_template: "evidence:nuclei:{sha256(.matched_at + .template_id)[:16]}"
        properties:
          - json_path: ".type"
            target: type
            default: "output"
          - json_path: ".extracted_results"
            target: content
            transform: json_stringify
          - json_path: ".curl_command"
            target: request_data
          - json_path: ".matched_at"
            target: url
          - json_path: ".timestamp"
            target: timestamp
            default: "{_context.timestamp}"
          - json_path: ".template_id"
            target: finding_id
            template: "finding:{.template_id}:{sha256(.matched_at)[:16]}"
        relationships:
          # Link evidence to finding
          - type: SUPPORTS
            from_template: "evidence:nuclei:{sha256(.matched_at + .template_id)[:16]}"
            to_template: "finding:{.template_id}:{sha256(.matched_at)[:16]}"
            properties:
              - name: collected_at
                value: "{_context.timestamp}"

  # ============================================================================
  # AMASS - In-depth Attack Surface Mapping
  # ============================================================================
  # Extracts domains, subdomains, and infrastructure relationships
  - tool: amass
    description: "In-depth attack surface mapping and asset discovery"
    output_format: json
    extracts:
      # Extract domain nodes
      - node_type: domain
        json_path: "$.domains[*]"
        id_template: "domain:{.name}"
        properties:
          - json_path: ".name"
            target: name
          - json_path: ".registrar"
            target: registrar
          - json_path: ".created_date"
            target: created_date
          - json_path: ".expires_date"
            target: expires_date
          - json_path: ".nameservers"
            target: nameservers
        relationships:
          # Link agent run to discovered domain
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "domain:{.name}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "amass"

      # Extract subdomain nodes
      - node_type: subdomain
        json_path: "$.subdomains[*]"
        id_template: "subdomain:{.name}"
        properties:
          - json_path: ".name"
            target: name
          - json_path: ".domain"
            target: parent_domain
          - json_path: ".source"
            target: discovery_method
        relationships:
          # Link subdomain to parent domain
          - type: HAS_SUBDOMAIN
            from_template: "domain:{.domain}"
            to_template: "subdomain:{.name}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: source
                value: "{.source}"
          # Link agent run to discovered subdomain
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "subdomain:{.name}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

      # Extract host nodes with IP addresses
      - node_type: host
        json_path: "$.addresses[*]"
        id_template: "host:{.ip}"
        properties:
          - json_path: ".ip"
            target: ip
          - json_path: ".asn"
            target: asn
          - json_path: ".cidr"
            target: cidr
          - json_path: ".description"
            target: description
        relationships:
          # Link subdomain to host (A/AAAA record)
          - type: RESOLVES_TO
            from_template: "subdomain:{.associated_subdomain}"
            to_template: "host:{.ip}"
            condition: ".associated_subdomain != null"
            properties:
              - name: record_type
                value: "{.record_type}"
              - name: discovered_at
                value: "{_context.timestamp}"
          # Link agent run to discovered host
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "host:{.ip}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"

  # ============================================================================
  # MASSCAN - Fast Port Scanner
  # ============================================================================
  # Extracts hosts and ports from masscan results (similar to nmap but faster)
  - tool: masscan
    description: "Fast TCP port scanner"
    output_format: json
    extracts:
      # Extract host nodes
      - node_type: host
        json_path: "$.hosts[*]"
        id_template: "host:{.ip}"
        properties:
          - json_path: ".ip"
            target: ip
          - json_path: ".version"
            target: version
            default: "ipv4"
        relationships:
          # Link agent run to discovered host
          - type: DISCOVERED
            from_template: "agent_run:{_context.agent_run_id}"
            to_template: "host:{.ip}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: tool
                value: "masscan"

      # Extract port nodes
      - node_type: port
        json_path: "$.hosts[*].ports[*]"
        id_template: "port:{_parent.ip}:{.port}:{.proto}"
        properties:
          - json_path: ".port"
            target: number
          - json_path: ".proto"
            target: protocol
          - json_path: ".status"
            target: state
          - json_path: "_parent.ip"
            target: host_id
            template: "host:{_parent.ip}"
        relationships:
          # Link host to port
          - type: HAS_PORT
            from_template: "host:{_parent.ip}"
            to_template: "port:{_parent.ip}:{.port}:{.proto}"
            properties:
              - name: discovered_at
                value: "{_context.timestamp}"
              - name: scan_rate
                value: "{_root.rate}"

# ============================================================================
# SCHEMA METADATA
# ============================================================================
metadata:
  version: "0.15.0"
  description: "Tool output schemas for Taxonomy-Driven GraphRAG"
  updated_at: "2026-01-12"

# ============================================================================
# NOTES
# ============================================================================
#
# JSONPath expressions:
# - $ refers to the root of the JSON document
# - @ refers to the current node being processed
# - * is a wildcard for all elements in an array or object
# - [*] selects all array elements
# - . accesses object properties
# - .. recursive descent (searches all levels)
#
# ID templates:
# - Use {.field} to reference JSON fields
# - Use {_parent.field} to reference parent object fields
# - Use {_root.field} to reference root document fields
# - Use {_context.var} to reference context variables
# - Use {sha256(...)} for hash-based IDs (prevents collisions)
# - Use [:16] to truncate hash to 16 characters
#
# Relationships:
# - from_template: Source node ID template
# - to_template: Target node ID template
# - condition: Optional JSONPath boolean expression to filter relationships
# - properties: Optional relationship properties
#
# Property transforms:
# - lowercase: Convert string to lowercase
# - uppercase: Convert string to uppercase
# - to_array: Convert single value to array
# - json_stringify: Convert object to JSON string
#
# Conditions:
# - Simple JSONPath boolean expressions (e.g., ".name != null")
# - Evaluated before node/relationship creation
# - Skip extraction if condition evaluates to false
