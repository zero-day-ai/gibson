name: Build Gibson Containers

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zero-day-ai/gibson

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      sdk: ${{ steps.versions.outputs.sdk }}
      gibson: ${{ steps.versions.outputs.gibson }}
      tools: ${{ steps.versions.outputs.tools }}
      agents: ${{ steps.versions.outputs.agents }}
      plugins: ${{ steps.versions.outputs.plugins }}
    steps:
      - uses: actions/checkout@v4
      - name: Parse versions
        id: versions
        run: |
          echo "sdk=$(jq -r '.sdk' versions.json)" >> $GITHUB_OUTPUT
          echo "gibson=$(jq -r '.gibson' versions.json)" >> $GITHUB_OUTPUT
          echo "tools=$(jq -r '.tools' versions.json)" >> $GITHUB_OUTPUT
          echo "agents=$(jq -r '.agents' versions.json)" >> $GITHUB_OUTPUT
          echo "plugins=$(jq -r '.plugins' versions.json)" >> $GITHUB_OUTPUT
      - name: Validate tags exist
        run: |
          # Use git ls-remote to verify tags exist (works without auth for public repos)
          git ls-remote --tags https://github.com/zero-day-ai/sdk.git | grep -q "refs/tags/${{ steps.versions.outputs.sdk }}" || (echo "SDK tag not found" && exit 1)
          git ls-remote --tags https://github.com/zero-day-ai/gibson.git | grep -q "refs/tags/${{ steps.versions.outputs.gibson }}" || (echo "Gibson tag not found" && exit 1)
          git ls-remote --tags https://github.com/zero-day-ai/gibson-tools-official.git | grep -q "refs/tags/${{ steps.versions.outputs.tools }}" || (echo "Tools tag not found" && exit 1)
          git ls-remote --tags https://github.com/zero-day-ai/gibson-agents-official.git | grep -q "refs/tags/${{ steps.versions.outputs.agents }}" || (echo "Agents tag not found" && exit 1)
          git ls-remote --tags https://github.com/zero-day-ai/gibson-plugins-official.git | grep -q "refs/tags/${{ steps.versions.outputs.plugins }}" || (echo "Plugins tag not found" && exit 1)
          echo "All tags validated successfully"

  build-oss:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./build
          file: ./build/Dockerfile.oss
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:oss-${{ needs.validate.outputs.gibson }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:oss-latest
          build-args: |
            SDK_VERSION=${{ needs.validate.outputs.sdk }}
            GIBSON_VERSION=${{ needs.validate.outputs.gibson }}
            TOOLS_VERSION=${{ needs.validate.outputs.tools }}
          labels: |
            gibson.sdk.version=${{ needs.validate.outputs.sdk }}
            gibson.version=${{ needs.validate.outputs.gibson }}
            gibson.tools.version=${{ needs.validate.outputs.tools }}

  build-enterprise:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: ./build
          file: ./build/Dockerfile.enterprise
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:enterprise-${{ needs.validate.outputs.gibson }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:enterprise-latest
          build-args: |
            SDK_VERSION=${{ needs.validate.outputs.sdk }}
            GIBSON_VERSION=${{ needs.validate.outputs.gibson }}
            TOOLS_VERSION=${{ needs.validate.outputs.tools }}
            AGENTS_VERSION=${{ needs.validate.outputs.agents }}
            PLUGINS_VERSION=${{ needs.validate.outputs.plugins }}
          labels: |
            gibson.sdk.version=${{ needs.validate.outputs.sdk }}
            gibson.version=${{ needs.validate.outputs.gibson }}
            gibson.tools.version=${{ needs.validate.outputs.tools }}
            gibson.agents.version=${{ needs.validate.outputs.agents }}
            gibson.plugins.version=${{ needs.validate.outputs.plugins }}
